✅ State-aware 'get_weather_stateful' tool defined.
{'user_preference_temperature_unit': 'Celsius'}

--- Testing State: Temp Unit Conversion & output_key ---
--- Turn 1: Requesting weather in London (expect Celsius) ---

>>> User Query: What's the weather in London?
  [Event] Author: weather_agent_v1, Type: Event, Final: False, Content: parts=[Part(
  function_call=FunctionCall(
    args={
      'city': 'London'
    },
    id='adk-b29143eb-71a8-49d8-916d-5d1db24538dc',
    name='get_weather_stateful'
  )
)] role='model'
--- Tool: get_weather_stateful called for London ---
--- Tool: Reading state 'user_preference_temperature_unit': Celsius ---
--- Tool: Generated report in Celsius. Result: {'status': 'success', 'report': 'The weather in London is cloudy with a temperature of 15°C.'} ---
--- Tool: Updated state 'last_city_checked_stateful': London ---
  [Event] Author: weather_agent_v1, Type: Event, Final: False, Content: parts=[Part(
  function_response=FunctionResponse(
    id='adk-b29143eb-71a8-49d8-916d-5d1db24538dc',
    name='get_weather_stateful',
    response={
      'report': 'The weather in London is cloudy with a temperature of 15°C.',
      'status': 'success'
    }
  )
)] role='user'
  [Event] Author: weather_agent_v1, Type: Event, Final: True, Content: parts=[Part(
  text="""The weather in London is cloudy with a temperature of 15°C.
"""
)] role='model'
<<< Agent Response: The weather in London is cloudy with a temperature of 15°C.


--- Manually Updating State: Setting unit to Fahrenheit ---
--- Stored session state updated. Current 'user_preference_temperature_unit': Fahrenheit ---

--- Turn 2: Requesting weather in New York (expect Fahrenheit) ---

>>> User Query: Tell me the weather in New York.
  [Event] Author: weather_agent_v1, Type: Event, Final: False, Content: parts=[Part(
  function_call=FunctionCall(
    args={
      'city': 'New York'
    },
    id='adk-8fccf1b7-0810-4d9e-9cb4-a78fa69afda7',
    name='get_weather_stateful'
  )
)] role='model'
--- Tool: get_weather_stateful called for New York ---
--- Tool: Reading state 'user_preference_temperature_unit': Fahrenheit ---
--- Tool: Generated report in Fahrenheit. Result: {'status': 'success', 'report': 'The weather in New york is sunny with a temperature of 77°F.'} ---
--- Tool: Updated state 'last_city_checked_stateful': New York ---
  [Event] Author: weather_agent_v1, Type: Event, Final: False, Content: parts=[Part(
  function_response=FunctionResponse(
    id='adk-8fccf1b7-0810-4d9e-9cb4-a78fa69afda7',
    name='get_weather_stateful',
    response={
      'report': 'The weather in New york is sunny with a temperature of 77°F.',
      'status': 'success'
    }
  )
)] role='user'
  [Event] Author: weather_agent_v1, Type: Event, Final: True, Content: parts=[Part(
  text="""The weather in New york is sunny with a temperature of 77°F.
"""
)] role='model'
<<< Agent Response: The weather in New york is sunny with a temperature of 77°F.


--- Turn 3: Sending a greeting ---

>>> User Query: Hi!
  [Event] Author: weather_agent_v1, Type: Event, Final: False, Content: parts=[Part(
  function_call=FunctionCall(
    args={
      'agent_name': 'greeting_agent'
    },
    id='adk-e3e2d7f0-5026-4570-ac14-829aea80860c',
    name='transfer_to_agent'
  )
)] role='model'
  [Event] Author: weather_agent_v1, Type: Event, Final: False, Content: parts=[Part(
  function_response=FunctionResponse(
    id='adk-e3e2d7f0-5026-4570-ac14-829aea80860c',
    name='transfer_to_agent',
    response={
      'result': None
    }
  )
)] role='user'
  [Event] Author: greeting_agent, Type: Event, Final: False, Content: parts=[Part(
  function_call=FunctionCall(
    args={},
    id='adk-b7ab142d-b8f2-45f1-8017-4d55353ba99e',
    name='say_hello'
  )
)] role='model'
--- Tool: say_hello called without a specific name (name_arg_value: None) ---
  [Event] Author: greeting_agent, Type: Event, Final: False, Content: parts=[Part(
  function_response=FunctionResponse(
    id='adk-b7ab142d-b8f2-45f1-8017-4d55353ba99e',
    name='say_hello',
    response={
      'result': 'Hello there!'
    }
  )
)] role='user'
  [Event] Author: greeting_agent, Type: Event, Final: True, Content: parts=[Part(
  text="""Hello there!
"""
)] role='model'
<<< Agent Response: Hello there!


--- Inspecting Final Session State ---
Final Preference: Fahrenheit
Final Last Weather Report (from output_key): The weather in New york is sunny with a temperature of 77°F.

Final Last City Checked (by tool): New York